name: TRMNL Keepalive

on:
  schedule:
    - cron: "* * * * *"      # every minute
  workflow_dispatch:          # lets you click "Run workflow"
  push:
    paths:
      - ".github/workflows/trmnl-keepalive.yml"

permissions:
  contents: read

concurrency:
  group: trmnl-keepalive
  cancel-in-progress: false

env:
  BASE_URL: https://trmnl-redirect-bus.onrender.com
  STOP_A: "45379"
  STOP_B: "45489"
  STOP_C: "45371"

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Ping /healthz (fast)
        run: |
          curl -fsS -m 8 "$BASE_URL/healthz" -o /dev/null || echo "healthz failed"

      - name: Ping /redirect (fast JSON)
        run: |
          curl -fsS -m 8 \
            "$BASE_URL/redirect?stop_a=$STOP_A&stop_b=$STOP_B&stop_c=$STOP_C" \
            -H 'Accept: application/json' -o /dev/null || echo "redirect failed"

      - name: Occasionally warm /image.png (heavier)
        run: |
          if [ $((RANDOM % 2)) -eq 0 ]; then
            curl -fsS -m 12 \
              "$BASE_URL/image.png?stop_a=$STOP_A&stop_b=$STOP_B&stop_c=$STOP_C" \
              -o /dev/null || echo "image failed"
          fi
